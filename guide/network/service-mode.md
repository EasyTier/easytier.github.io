# 服务管理与混合模式

EasyTier 支持一种高度灵活的“服务化”运行模式。通过结合本地配置文件目录和远程管理接口，`easytier-core` 可以作为一个持久运行的系统服务，同时管理多个静态和动态的网络实例。

## 核心概念

### 混合模式 (Hybrid Mode)
在混合模式下，EasyTier 节点不再仅仅依赖于启动时的命令行参数或单个配置文件。它可以：
1. **加载本地配置**：自动加载指定目录下的所有配置文件。
2. **接受远程管理**：通过 Web 控制台或 GUI 实时添加、修改或停止网络实例。**注意：必须配合 `-w <用户名>` 参数才能连接到 Web 控制台进行远程管理（详见 [使用 Web 控制台](web-console.md)）。**
3. **服务常驻**：即使没有任何网络正在运行，只要开启了远程管理（或指定了守护进程标志），服务进程也会保持运行，等待指令。

### 目录级配置加载 (`--config-dir`)
通过 `--config-dir` 参数，你可以指定一个文件夹作为配置源。EasyTier 会扫描该文件夹下所有的 `.toml` 文件并为每个文件启动一个独立的网络实例。

```sh
easytier-core --config-dir /etc/easytier/conf.d -w <用户名>
```

## 远程配置持久化

当使用 `--config-dir` 运行 EasyTier 时，通过 Web 控制台或 GUI 远程下发的配置将自动持久化到该目录下。

- **自动命名**：远程创建的网络会以其 UUID 命名（如 `8e5f...toml`）。
- **重启恢复**：服务重启后，这些持久化文件会被重新扫描并加载，确保网络连接的连续性。

## 权限与安全性控制

为了防止意外修改核心配置文件，EasyTier 引入了精细的权限控制模型。每个网络实例的权限取决于其来源：

| 配置来源 | 远程修改 (Web/GUI) | 远程停止/删除 | 说明 |
| :--- | :---: | :---: | :--- |
| **配置目录中的 UUID 文件** | ✅ | ✅ | 由远程管理端生成的动态配置 |
| **单个配置文件 (`-c`)** | ✅ | ❌ | 静态指定的文件允许修改，但不能被远程删除 |
| **只读文件 / 环境变量** | ❌ | ❌ | 文件系统标记为只读或使用了 `${VAR}` 的配置不可修改 |
| **命令行参数 / FFI** | ❌ | ❌ | 临时运行的实例不支持远程持久化修改 |

::: tip 提示
如果你希望某个手动创建的配置文件既能被远程修改也能被远程删除，请将其放置在 `--config-dir` 目录下，并确保其文件名符合 UUID 格式（或确保其拥有写权限）。
:::

## 最佳实践：作为系统服务运行

建议将 EasyTier 安装为系统服务（如 Systemd），并配合 `--config-dir` 使用：

1. **安装服务**：使用 `easytier-cli service install` 或手动配置 Systemd 单元。
2. **配置入口**：在 Service 配置中加入 `--config-dir /etc/easytier/conf.d`。
3. **动态管理**：之后你只需在 Web 控制台操作，所有变更都会同步保存到服务器本地，无需再次登录服务器修改 Systemd 配置。

::: tip GUI 用户提示
如果你正在使用 EasyTier GUI，则不需要手动配置命令行。GUI 已内置了“服务模式”，支持在界面中一键安装、卸载和管理系统服务。详情请参考 [GUI 运行模式](/guide/gui/modes)。
:::
